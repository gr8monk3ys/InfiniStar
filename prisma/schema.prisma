// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                     String    @id @default(auto()) @map("_id") @db.ObjectId
  name                   String?
  email                  String?   @unique
  emailVerified         DateTime?
  image                  String?
  hashedPassword        String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Profile fields
  bio                    String?   // User bio/about me
  location               String?   // User location
  website                String?   // User website URL

  // Presence fields
  presenceStatus         String?   @default("offline") // "online", "offline", "away"
  lastSeenAt             DateTime? // Last time user was active
  customStatus           String?   // Custom status message
  customStatusEmoji      String?   // Emoji for custom status

  // Email verification
  verificationToken     String?   @unique
  verificationTokenExpiry DateTime?

  // Password reset
  resetToken            String?   @unique
  resetTokenExpiry      DateTime?

  stripeCustomerId      String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId  String?   @unique @map("stripe_subscription_id")
  stripePriceId         String?   @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end")

  conversationIds String[] @db.ObjectId
  conversations Conversation[] @relation(fields: [conversationIds], references: [id])
  
  seenMessageIds String[] @db.ObjectId
  seenMessages Message[] @relation("Seen", fields: [seenMessageIds], references: [id])
  
  messages Message[]

  accounts Account[]
  sessions Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Conversation {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime @default(now())
  lastMessageAt DateTime @default(now())
  name          String?
  isGroup       Boolean  @default(false)
  isAI          Boolean  @default(false)
  aiModel       String?  // e.g., "claude-3-5-sonnet-20241022"
  aiSystemPrompt String? // Custom system prompt for AI personality
  aiPersonality  String? // Preset personality: "assistant", "creative", "technical", "friendly", "professional", "custom"

  // Archiving functionality
  archivedBy     String[] @db.ObjectId // Array of user IDs who archived this conversation
  archivedAt     DateTime? // When conversation was first archived (by any user)

  // Pinning functionality
  pinnedBy       String[] @db.ObjectId // Array of user IDs who pinned this conversation
  pinnedAt       DateTime? // When conversation was first pinned (by any user)

  // Muting functionality
  mutedBy        String[] @db.ObjectId // Array of user IDs who muted this conversation
  mutedAt        DateTime? // When conversation was first muted (by any user)

  messageIds String[] @db.ObjectId
  messages   Message[]

  userIds String[] @db.ObjectId
  users   User[]   @relation(fields: [userIds], references: [id])

  @@map("conversations")
}

model Message {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  body      String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  editedAt  DateTime? // Track when message was last edited
  deletedAt DateTime? // Soft delete timestamp
  isDeleted Boolean  @default(false) // Soft delete flag
  isAI      Boolean  @default(false) // True if message is from AI

  // Reactions stored as JSON: { "üëç": ["userId1", "userId2"], "‚ù§Ô∏è": ["userId3"] }
  reactions Json?    @default("{}")

  // Reply/threading support
  replyToId String?  @db.ObjectId
  replyTo   Message? @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies   Message[] @relation("MessageReplies")

  seenIds String[] @db.ObjectId
  seen    User[]   @relation("Seen", fields: [seenIds], references: [id])

  conversationId String       @db.ObjectId
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String @db.ObjectId
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model AiUsage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())

  // User and conversation references
  userId         String @db.ObjectId
  conversationId String @db.ObjectId

  // Model information
  model String // e.g., "claude-3-5-sonnet-20241022"

  // Token usage
  inputTokens  Int
  outputTokens Int
  totalTokens  Int

  // Cost estimation (in cents)
  inputCost  Float
  outputCost Float
  totalCost  Float

  // Request metadata
  requestType String // "chat" or "chat-stream"
  latencyMs   Int?   // Response time in milliseconds

  @@map("ai_usage")
  @@index([userId])
  @@index([conversationId])
  @@index([createdAt])
}